<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Vuex Sync Part 1 | Matthew C Dev</title><meta name=keywords content="development,vuex,web,typescript"><meta name=description content="This is the tale of how I wrote a state syncing framework based on vuex and rollback netcode . It took a few years and isn&rsquo;t intended to be a &ldquo;copy and paste&rdquo; type of thing. I&rsquo;ll be including code fragments and I&rsquo;ll eventually post a cleaned up repo with only the relevant pieces. Who knows, if there&rsquo;s enough interest, maybe I&rsquo;ll even post a NPM package.
TL;DR This is a long article."><meta name=author content="Me"><link rel=canonical href=https://matthewc.dev/projects/vuex-sync-p1/><meta name=google-site-verification content="56rW1rUI4LWedkHQTqbYEQ1DHqRwd8GqLln3Pg8FI-o"><meta name=msvalidate.01 content="0764BC2BC3D20B77B39F91E88453504E"><link crossorigin=anonymous href=/assets/css/stylesheet.min.76e290d636957edc05657d8b067ecd49300da8689c927613e8d9ec04fe856657.css integrity="sha256-duKQ1jaVftwFZX2LBn7NSTANqGicknYT6NnsBP6FZlc=" rel="preload stylesheet" as=style><link rel=preload href=/logo.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://matthewc.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://matthewc.dev/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://matthewc.dev/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://matthewc.dev/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://matthewc.dev/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Vuex Sync Part 1"><meta property="og:description" content="This is the tale of how I wrote a state syncing framework based on vuex and rollback netcode . It took a few years and isn&rsquo;t intended to be a &ldquo;copy and paste&rdquo; type of thing. I&rsquo;ll be including code fragments and I&rsquo;ll eventually post a cleaned up repo with only the relevant pieces. Who knows, if there&rsquo;s enough interest, maybe I&rsquo;ll even post a NPM package.
TL;DR This is a long article."><meta property="og:type" content="article"><meta property="og:url" content="https://matthewc.dev/projects/vuex-sync-p1/"><meta property="og:image" content="https://matthewc.dev/Vuex.png"><meta property="article:section" content="projects"><meta property="article:published_time" content="2021-11-25T20:56:33-06:00"><meta property="article:modified_time" content="2022-02-21T09:12:06-06:00"><meta property="og:site_name" content="Matthew Carlson"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://matthewc.dev/Vuex.png"><meta name=twitter:title content="Vuex Sync Part 1"><meta name=twitter:description content="This is the tale of how I wrote a state syncing framework based on vuex and rollback netcode . It took a few years and isn&rsquo;t intended to be a &ldquo;copy and paste&rdquo; type of thing. I&rsquo;ll be including code fragments and I&rsquo;ll eventually post a cleaned up repo with only the relevant pieces. Who knows, if there&rsquo;s enough interest, maybe I&rsquo;ll even post a NPM package.
TL;DR This is a long article."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Projects","item":"https://matthewc.dev/projects/"},{"@type":"ListItem","position":2,"name":"Vuex Sync Part 1","item":"https://matthewc.dev/projects/vuex-sync-p1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Vuex Sync Part 1","name":"Vuex Sync Part 1","description":"This is the tale of how I wrote a state syncing framework based on vuex and rollback netcode . It took a few years and isn\u0026rsquo;t intended to be a \u0026ldquo;copy and paste\u0026rdquo; type of thing. I\u0026rsquo;ll be including code fragments and I\u0026rsquo;ll eventually post a cleaned up repo with only the relevant pieces. Who knows, if there\u0026rsquo;s enough interest, maybe I\u0026rsquo;ll even post a NPM package.\nTL;DR This is a long article.","keywords":["development","vuex","web","typescript"],"articleBody":"This is the tale of how I wrote a state syncing framework based on vuex and rollback netcode . It took a few years and isn’t intended to be a “copy and paste” type of thing. I’ll be including code fragments and I’ll eventually post a cleaned up repo with only the relevant pieces. Who knows, if there’s enough interest, maybe I’ll even post a NPM package.\nTL;DR This is a long article. The short version is that I wrote a system that makes it easy to create rooms on an express.js server and have a finite state machine that is synced between all clients. The client and the server can make auditable transformations to that state with enforced checks and some hidden state. It’s based on vuex and so far I think it works awesome. As far as I can find on GitHub and Reddit, no one has done it before (at least in a satisfactory manor). There’s probably a good reason for it.\nYou would likely use a system like this if you were trying to keep shared state between a number of clients. This can apply to things like a game of Jeopardy that runs on phones, a crossword app, etc. Something where you want a significant portion of the state between clients to overlap and to have multiple sources of change.\nThe Problem First a tangent. A few years ago, I started on a project known as PadGames.\nThe idea was to take the things I liked about Jackbox games and incorporate them in a format that they could be played from anywhere. If you’ve never played Jackbox games, the idea is that there’s a laptop or desktop that serves as a “game board” of sorts and you have your phone as a client that connects as acts as a controller. You can draw, type in answers, etc. Anything that isn’t too latency sensitive generally works well. Syncing state is a difficult problem and even Jackbox struggles with this. My parents have often had a broken game state, refreshed their browser, and discovered that they’ve been kicked out of the game and cannot join back in\nIn the earliest versions of PadGames, I had simpler games such as a stock market where you could buy and sell stocks. The goal was to make the most money and prices went up and down based on what people bought and sold in the previous turn. It was largely a teaching tool for some local youth, getting them somewhat similar with the idea of the market as well as being fun. The game ran on express, vue, and socket.io. Even thought the server and the client shared a codebase, there being a tedious serialization and de-serialization layer that I had to write two or three times. Personally, the experience was painful and I eventually quit the project since the code just became spaghetti so fast and it was getting harder and harder to track down state bugs as every game was slightly different.\nLater, I worked with Luke on netgames.io . (I say worked on, but it was more of a helped out with since he started the project and did the hard work of creating a fantastic framework). His work is closed-source, so I won’t delve too much into how it worked but the point was that it provided a clean abstraction layer that you could put UI and game logic on top of.\nTo make a long story short, I wanted to create some new teaching resources for some volunteering work and wasn’t entirely satisfied with what was out there. Something jackbox games like but related to the material we were covering that day. Making my own games seemed like a good solution and I had done it a few times before. But syncing state was still an issue.\nSo the problem is this: create a way for the server and the clients to share a state machine, have it sync without any code on my part. It must be robust and resilient against network interruption and latency in a multi-peer environment. Additionally, it must handle users connecting and reconnecting.\nThe Initial Attempt I poked around the web trying to find something similar to this. I wasn’t able to find anything that quite worked or was even that similar. It needed to be fast and low-latency with low latency, so a meteor like pub-sub system seemed like it wouldn’t work as well as I hoped (the latency seemed too high, but perhaps it has gotten better over time).\nThe first attempt at this was to create a simple class that the client and server shared. Basically, it had a state object internally and methods for modifying that state that could be listened to. The approach worked at first, but reactivity was tough. I think this approach could have worked, if I had hooked it in a more focused way and added ways to provide reactivity. In the future, I might revisit this approach.\nSecond Try The solution was to use vuex on the client and the server. Thanks to Vue v3 composition API, it is way easier to run Vuex (sort of) on the server. In my testing on my laptop, a single express instance could handle 50,000 Vuex stores (though that stress test isn’t with all the clients connected, just by making toggling state). So by creating a vuex store with specific format, it could easily be synced.\nThere are a few rules for writing a store:\nAll mutations must be deterministic, actions can be random. Actions on the client side will be transmitted to the server Actions must have the source of the action included in the payload, it is replaced by the server when the request comes in, so the actual client sends null Mutations on the server as synced, any mutation with Server in the name is not synced All synced stores must implement a method known as setState which accepts the state of the object and sets the state using vuex methods so reactivity is preserved All synced stores must implement a getter that returns the hash of the current state (minus the server side information). All this boiled down to three basic pieces: client plugin, the server vuex, and the store itself.\nThe Client Plugin There are a few steps to the client plugin:\nCreate websocket Connect the websocket’s defined events to the plugin and some admin things Setup reconnect events to request a sync The plugin itself also implements something akin to rollback netcode.\nStep 1-2: Creating the websocket In my main store which keeps track of login, the jwt cookie, the current game selected, and our user information, we have an action called getLogin. I’m using vuex-smart-module to define my vuex stores, since it’s just so fantastic. But you’re welcome to adapt the ideas to whatever method you’re using. The getLogin method runs when the store is initialized.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 import { io, Socket } from \"socket.io-client\"; import { Store } from \"vuex\"; // Globals type WebSocket = Socket\u003cDefaultEventsMap, DefaultEventsMap\u003e; let SOCKET: null | WebSocket = null; // ... truncated ... class MainStoreActions extends Actions\u003c MainStoreState, MainStoreGetters, MainStoreMutations, MainStoreActions \u003e { // Called after the module is initialized $init(store: Store\u003cany\u003e): void { this.actions.checkLogin(); } checkLogin() { const state = this.state; if (state.loggedIn) return; // ... JWT parsing code truncated ... // Connect if (state.loggedIn \u0026\u0026 SOCKET == null) { SOCKET = io({ auth: { token: this.state.jwtCookie, } }); const self = this; SOCKET.on(SocketEvents.SET_GAME, (item: unknown) =\u003e { if (typeof (item) != \"string\") return; const game = item; if (game == '' \u0026\u0026 self.state.currentGame != '') { console.log(\"refreshing the page to clear state\", game, self.state.currentGame); window.location.reload(); } self.mutations.setGame(game); }); SOCKET.on(SocketEvents.SERVER_MUTATION, (items: any) =\u003e { self.mutations.server_mutation(items); }); SOCKET.on('reconnect', ()=\u003e{ self.actions.requestGameSync(); }) } } async requestGameSync() { this.actions.emit(SocketEvents.GAME_SYNC); } async emit(message: string | [string, any]) { if (SOCKET == null) { console.error(\"Socket isn't initialized, dropping message\", message); return; } if (typeof(message) == 'string') { SOCKET.emit(message); return; } const [type, items] = message; SOCKET.emit(type, items); } } There are three important things here, we listen for a SET_GAME event from the server, which reloads the page if we already had a game set. We also issue a special mutation called setGame which is leveraged later. We listen to an event called SERVER_MUTATION and then confusingly we issue a new mutation called server_mutation, this will make sense. Lastly, we tell it to request a resync packet when we reconnect. By default, the server doesn’t listen to reconnects and just responds to reconnect packages as needed. This might be revised in the future.\nRequesting a game sync packet is just emitting the GAME_SYNC packet. Emitting is an action that leverages the socket.\nNext we look at the mutations, setGame isn’t anything special, we just set the local state. server_mutation is strange as it doesn’t do anything.\n1 2 3 4 5 6 7 8 9 class MainStoreMutations extends Mutations\u003cMainStoreState\u003e { setGame(game: string) { this.state.currentGame = game;ß } server_mutation(data: any) { // the plugin will grab this return true; } } We pass in some data to server_mutation, but don’t use it. The reason for this is that the plugin listens to that mutation.\nIf you’re not familiar with the basics of vuex, I’d recommend brushing up . The short version is that there are four parts to a vuex module (as of time of writing): state, getters, mutations, and actions. State is the actual state of the store, which is reactive. It is readonly and can only be modified by mutations. Getters are a way to map the state to different forms in a reactive way. Mutations are methods that accept arguments and perform transformations to the state. Actions are like mutations, but they cannot directly modify the state. Additionally, they can be async so you often put http calls in here.\nStep 3: Onto the plugin itself I’ve broken it up into three sections.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 import { ActionExtraPayload, ActionPacket, ActionPayload, ActionSource, isActionExtraPayload, isActionSource, MutationPacket, SocketEvents } from \"../../common/types\"; import { Store } from \"vuex\"; import _ from \"lodash\"; // Mutation packet looks like this /* interface { type: string; payload: any; resultHash: number; } */ const serverMutationChain:MutationPacket[] = []; const localMutationChain:MutationPacket[] = []; let resync_requested = false; export default function clientSideSocketPlugin(store: Store\u003cany\u003e) { store.subscribe(mutation =\u003e { // ... mutations are tracked here ... }) store.subscribeAction({ // ... actions tracked here ... }, { prepend: true }); } I’ll put a huge disclaimer here that this is not polished code, this is code pumped out at 9pm in a after-work coding frenzy. The kind of frenzy you get when you see progress being made and you keep pushing to extract whatever you can.\nSo you can see we subscribe to mutations and actions. Additionally, we keep track of two “chains”: the local and the server. The local chain is all the mutations that have occurred on the client and server is all the mutations that we’ve received from the server. These chains are reset when we set the game mode or receive a setState packet from the server as we now have a known state to start from.\nLet’s see how the we listen to mutations.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 import { ActionExtraPayload, ActionPacket, ActionPayload, ActionSource, isActionExtraPayload, isActionSource, MutationPacket, SocketEvents } from \"../../common/types\"; import { Store } from \"vuex\"; import _ from \"lodash\"; const serverMutationChain:MutationPacket[] = []; const localMutationChain:MutationPacket[] = []; let resync_requested = false; export default function clientSideSocketPlugin(store: Store\u003cany\u003e) { store.subscribe(mutation =\u003e { if (mutation.type == 'setGame') { // Clear our chains when the game resets console.log(\"Clearing mutation chains because game reset\"); if (serverMutationChain.length == 0 \u0026\u0026 localMutationChain.length == 0) return; const gameName = mutation.payload; if (gameName != '') store.commit(gameName+\"/setState\"); serverMutationChain.splice(0, serverMutationChain.length); localMutationChain.splice(0, localMutationChain.length); return; } const currentGame = store.getters.currentGame as string; if (currentGame == null || currentGame.length == 0) return; // We know we have a game if (mutation.type == 'server_mutation') { const packet = mutation.payload as MutationPacket; if (packet.type.endsWith(\"setState\")) { console.log(\"Special set state packet\"); // reset both sets of mutation chains resync_requested = false; serverMutationChain.splice(0, serverMutationChain.length); localMutationChain.splice(0, localMutationChain.length); } serverMutationChain.push(packet); // Step 1: Check if we need to apply this packet, look in our local mutation chain to see if we've already done it let shouldApply = false; let outOfSync = false; console.log(\"Got server packet \"+packet.type, serverMutationChain, localMutationChain); if (serverMutationChain.length \u003e localMutationChain.length) shouldApply = true; if (!shouldApply) { // Scan ahead to see if we've already done this exact commit? const hash = store.getters[currentGame+'/stateHash']; console.log(\"Scan ahead to see if we've already applied this packet\",hash,packet.resultHash); outOfSync = hash != packet.resultHash; } if (!outOfSync \u0026\u0026 shouldApply){ console.log(\"server mutation\", mutation, JSON.stringify(packet)); store.commit(packet.type, packet.payload); // TODO: look at state hash afterwards const hash = store.getters[currentGame+'/stateHash']; console.log(\"StateHash\", hash); if (hash != packet.resultHash) { outOfSync = true; console.error(\"Local hash = \"+hash, packet.resultHash); } } if (outOfSync \u0026\u0026 serverMutationChain.length != 0 \u0026\u0026 serverMutationChain[0].type.endsWith(\"setState\")) { console.log(\"Replaying server commits\"); localMutationChain.splice(0, serverMutationChain.length); serverMutationChain.forEach((x)=\u003e{ store.commit(x.type, x.payload); }); const current_hash = store.getters[currentGame+'/stateHash']; const last_hash = serverMutationChain[serverMutationChain.length - 1].resultHash; console.log(\"Replayed \"+ current_hash+ \" =?= \"+last_hash); outOfSync = current_hash != last_hash; } if (outOfSync \u0026\u0026 !resync_requested) { // We're out of sync, request a reset resync_requested = true; console.error(\"We've becoming desynced\"); store.dispatch('requestGameSync'); } } else if (mutation.type.startsWith(currentGame)){ const hash = store.getters[currentGame+'/stateHash']; // we should log all other mutations const packet: MutationPacket = { resultHash: _.clone(hash), type: mutation.type, payload: _.clone(mutation.payload) }; localMutationChain.push(packet); console.log(\"local mutation\", packet, hash); } }) store.subscribeAction({ // ... actions tracked here ... }, { prepend: true }); } So we listen to if we’re doing a setGame mutation. If so, reset the chains and bail. If we don’t have a game currently set, we can also bail. Then we check if this is a server_mutation mutation. Remember that from earlier? The wonky method that didn’t do anything? Yeah- it’s back baby.\nNext we look at the mutation that the server wants us to apply. If it’s a setState packet, we can clear the chains and go ahead as normal. We add the mutation to our server chain, then try to figure out if we need to apply the packet. We do that by calculating the hash of the current state and looking at the hash that the server state is at. It’s important that when we write our server hash function that we don’t include server only data in our hash. We determine if we’re out of sync from the server if our hashes don’t match. This is where rollback comes in, we start from the start of our chain (the first one should be a setGame packet), applying each packet we have from the server trying to make it all work and match.\nIf we have gotten to the end and we are still out of sync from the server, we request a resync packet. This means the server sends a setState packet just to us so that we can clear our chains and get to work. There needs to be some future work to add the client mutations ontop of what we have from the server, but currently the latency on the mutation occurring on the client and coming back from the server is under 200ms (not great, but enough that the likelihood of overlapping states are pretty low in most games). This will likely get a much more comprehensive overhaul in the future. Perhaps even with some unit tests?\nOur games are namespaced into the main vuex module so any mutation that’s occurring locally on the client will be prepended with the name of the game. For example, one game is called matchup so a common mutation we see is setPlayerButton so the event type would be matchup/setPlayerButton. If we see any mutations to start with our current game, we log them to our local chain.\nOnto listening for actions.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 import { ActionExtraPayload, ActionPacket, ActionPayload, ActionSource, isActionExtraPayload, isActionSource, MutationPacket, SocketEvents } from \"../../common/types\"; import { Store } from \"vuex\"; import _ from \"lodash\"; const serverMutationChain:MutationPacket[] = []; const localMutationChain:MutationPacket[] = []; let resync_requested = false; export default function clientSideSocketPlugin(store: Store\u003cany\u003e) { store.subscribe(mutation =\u003e { // ... mutations are tracked here ... }) store.subscribeAction({ after: (action, state) =\u003e { if (action.type.indexOf(\"/\") == -1) return; let tweaked_payload = _.cloneDeep(action.payload) as ActionPayload|null; if (isActionSource(tweaked_payload)) { tweaked_payload = null; } if (isActionExtraPayload(tweaked_payload)) { (tweaked_payload as any).source = null; } // tell the server that we've done a thing const packet:ActionPacket = { payload: tweaked_payload, type: action.type } store.dispatch('emit', [SocketEvents.CLIENT_ACTION, packet]); } }, { prepend: true }); } This is much simpler in comparison. After an action has been completed, we check to make sure it was namespaced (look for /). We have two types of payloads we can send to the server: ActionSource and ActionExtraPayload. ActionSource looks like this\n1 2 3 4 5 6 interface ActionSource { name: string, _id: number, socket_id: string, isAdmin: boolean, } ActionExtraPayload looks like this:\n1 2 3 interface ActionExtraPayload { source: ActionSource, } So the payload is either the source itself, or it has a member called source. Before we send it off to the server, we set these to null and then send it. This is important as on the server, we detect which type it is, and fill it in with the information from the socket JWT auth header.\nServer side Since this is already getting long, I’ll cover the server side in part 2. Since normal vuex doesn’t run on the server, I implemented a slimmed down version of it that supports most of the same features.\nThe Synced Store I’ll cover the store itself in part 3. There’s a common store that implements things like users being added and removed. All other stores extend from that store.\nWhere To Go From Here? I’m cleaning up my specific use private GitHub repo and publish a slimmed down version of this with a simple trivia game or maybe the stock market game I mentioned earlier. I think I’ll do that in part two, with some additional work working on improving the technique.\n","wordCount":"3197","inLanguage":"en","image":"https://matthewc.dev/Vuex.png","datePublished":"2021-11-25T20:56:33-06:00","dateModified":"2022-02-21T09:12:06-06:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://matthewc.dev/projects/vuex-sync-p1/"},"publisher":{"@type":"Organization","name":"Matthew C Dev","logo":{"@type":"ImageObject","url":"https://matthewc.dev/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://matthewc.dev/ accesskey=h title="Matthew Carlson (Alt + H)"><img src=https://matthewc.dev/logo.png alt=logo aria-label=logo height=35>Matthew Carlson</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://matthewc.dev/musings/ title=musings><span>musings</span></a></li><li><a href=https://matthewc.dev/projects/ title=projects><span>projects</span></a></li><li><a href=https://matthewc.dev/blender/ title=blender><span>blender</span></a></li><li><a href=https://www.linkedin.com/in/matthewfcarlson title=resume><span>resume</span></a></li><li><a href=https://matthewc.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://matthewc.dev/>Home</a>&nbsp;»&nbsp;<a href=https://matthewc.dev/projects/>Projects</a></div><h1 class=post-title>Vuex Sync Part 1</h1><div class=post-meta><span title='2022-02-21 09:12:06 -0600 -0600'>February 21, 2022</span>&nbsp;·&nbsp;16 min&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href="https://github.com/matthewfcarlson/matthewfcarlson.github.io/issues/new?body=Your+issue+here%0A%0A%0A---%0AI%27m+a+human.+Please+be+nice.&title=Issue%20with%20/projects/vuex-sync-p1/index.md" rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy srcset="https://matthewc.dev/projects/vuex-sync-p1/Vuex_hua98541822e93af9c5f3100be35257652_17193_360x0_resize_box_3.png 360w ,https://matthewc.dev/projects/vuex-sync-p1/Vuex_hua98541822e93af9c5f3100be35257652_17193_480x0_resize_box_3.png 480w ,https://matthewc.dev/projects/vuex-sync-p1/Vuex_hua98541822e93af9c5f3100be35257652_17193_720x0_resize_box_3.png 720w ,https://matthewc.dev/projects/vuex-sync-p1/Vuex_hua98541822e93af9c5f3100be35257652_17193_1080x0_resize_box_3.png 1080w ,https://matthewc.dev/projects/vuex-sync-p1/Vuex_hua98541822e93af9c5f3100be35257652_17193_1500x0_resize_box_3.png 1500w ,https://matthewc.dev/projects/vuex-sync-p1/Vuex.png 1650w" sizes="(min-width: 768px) 720px, 100vw" src=https://matthewc.dev/projects/vuex-sync-p1/Vuex.png alt width=1650 height=700></figure><div class=post-content><p>This is the tale of how I wrote a state syncing framework based on vuex and
<a href=https://en.wikipedia.org/wiki/Netcode>rollback netcode</a>
.
It took a few years and isn&rsquo;t intended to be a &ldquo;copy and paste&rdquo; type of thing.
I&rsquo;ll be including code fragments and I&rsquo;ll eventually post a cleaned up repo with only the relevant pieces.
Who knows, if there&rsquo;s enough interest, maybe I&rsquo;ll even post a NPM package.</p><h2 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h2><p>This is a long article.
The short version is that I wrote a system that makes it easy to create rooms on an express.js server and have a finite state machine that is synced between all clients.
The client and the server can make auditable transformations to that state with enforced checks and some hidden state.
It&rsquo;s based on vuex and so far I think it works awesome.
As far as I can find on GitHub and Reddit, no one has done it before (at least in a satisfactory manor).
There&rsquo;s probably a good reason for it.</p><p>You would likely use a system like this if you were trying to keep shared state between a number of clients.
This can apply to things like a game of Jeopardy that runs on phones, a crossword app, etc.
Something where you want a significant portion of the state between clients to overlap and to have multiple sources of change.</p><h2 id=the-problem>The Problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>First a tangent. A few years ago, I started on a project known as PadGames.</p><p><img loading=lazy srcset="https://matthewc.dev/projects/vuex-sync-p1/padgames_hu83a0f6eb3a151560ca718af008c32bef_23182_360x0_resize_box_3.png 360w ,https://matthewc.dev/projects/vuex-sync-p1/padgames_hu83a0f6eb3a151560ca718af008c32bef_23182_480x0_resize_box_3.png 480w ,https://matthewc.dev/projects/vuex-sync-p1/padgames_hu83a0f6eb3a151560ca718af008c32bef_23182_720x0_resize_box_3.png 720w ,https://matthewc.dev/projects/vuex-sync-p1/padgames_hu83a0f6eb3a151560ca718af008c32bef_23182_1080x0_resize_box_3.png 1080w ,https://matthewc.dev/projects/vuex-sync-p1/padgames_hu83a0f6eb3a151560ca718af008c32bef_23182_1500x0_resize_box_3.png 1500w ,https://matthewc.dev/projects/vuex-sync-p1/padgames.png 1150w" sizes="(min-width: 768px) 720px, 100vw" src=https://matthewc.dev/projects/vuex-sync-p1/padgames.png alt="old padgames logo"></p><p>The idea was to take the things I liked about
<a href="https://www.jackboxgames.com/?utm_source=matthewcdev">Jackbox games</a>
and incorporate them in a format that they could be played from anywhere.
If you&rsquo;ve never played Jackbox games, the idea is that there&rsquo;s a laptop or desktop that serves as a &ldquo;game board&rdquo; of sorts and you have your phone as a client that connects as acts as a controller.
You can draw, type in answers, etc. Anything that isn&rsquo;t too latency sensitive generally works well.
Syncing state is a difficult problem and even Jackbox struggles with this.
My parents have often had a broken game state, refreshed their browser, and discovered that they&rsquo;ve been kicked out of the game and cannot join back in</p><p>In the earliest versions of PadGames, I had simpler games such as a stock market where you could buy and sell stocks.
The goal was to make the most money and prices went up and down based on what people bought and sold in the previous turn.
It was largely a teaching tool for some local youth, getting them somewhat similar with the idea of the market as well as being fun.
The game ran on express, vue, and socket.io.
Even thought the server and the client shared a codebase, there being a tedious serialization and de-serialization layer that I had to write two or three times.
Personally, the experience was painful and I eventually quit the project since the code just became spaghetti so fast and it was getting harder and harder to track down state bugs as every game was slightly different.</p><p><img loading=lazy srcset="https://matthewc.dev/projects/vuex-sync-p1/spaghetti_code_hu229498794e1e1d135434b63b02fd4fc5_278712_360x0_resize_q75_box.jpeg 360w ,https://matthewc.dev/projects/vuex-sync-p1/spaghetti_code_hu229498794e1e1d135434b63b02fd4fc5_278712_480x0_resize_q75_box.jpeg 480w ,https://matthewc.dev/projects/vuex-sync-p1/spaghetti_code_hu229498794e1e1d135434b63b02fd4fc5_278712_720x0_resize_q75_box.jpeg 720w ,https://matthewc.dev/projects/vuex-sync-p1/spaghetti_code_hu229498794e1e1d135434b63b02fd4fc5_278712_1080x0_resize_q75_box.jpeg 1080w ,https://matthewc.dev/projects/vuex-sync-p1/spaghetti_code_hu229498794e1e1d135434b63b02fd4fc5_278712_1500x0_resize_q75_box.jpeg 1500w ,https://matthewc.dev/projects/vuex-sync-p1/spaghetti_code.jpeg 1300w" sizes="(min-width: 768px) 720px, 100vw" src=https://matthewc.dev/projects/vuex-sync-p1/spaghetti_code.jpeg alt="spaghetti code"></p><p>Later, I worked with Luke on
<a href=https://netgames.io/about>netgames.io</a>
.
(I say worked on, but it was more of a helped out with since he started the project and did the hard work of creating a fantastic framework).
His work is closed-source, so I won&rsquo;t delve too much into how it worked but the point was that it provided a clean abstraction layer that you could put UI and game logic on top of.</p><p>To make a long story short, I wanted to create some new teaching resources for some volunteering work and wasn&rsquo;t entirely satisfied with what was out there.
Something jackbox games like but related to the material we were covering that day.
Making my own games seemed like a good solution and I had done it a few times before.
But syncing state was still an issue.</p><p>So the problem is this: create a way for the server and the clients to share a state machine, have it sync without any code on my part.
It must be robust and resilient against network interruption and latency in a multi-peer environment.
Additionally, it must handle users connecting and reconnecting.</p><h2 id=the-initial-attempt>The Initial Attempt<a hidden class=anchor aria-hidden=true href=#the-initial-attempt>#</a></h2><p>I poked around the web trying to find something similar to this.
I wasn&rsquo;t able to find anything that quite worked or was even that similar.
It needed to be fast and low-latency with low latency, so a meteor like pub-sub system seemed like it wouldn&rsquo;t work as well as I hoped (the latency seemed too high, but perhaps it has gotten better over time).</p><p>The first attempt at this was to create a simple class that the client and server shared.
Basically, it had a state object internally and methods for modifying that state that could be listened to.
The approach worked at first, but reactivity was tough.
I think this approach could have worked, if I had hooked it in a more focused way and added ways to provide reactivity.
In the future, I might revisit this approach.</p><h2 id=second-try>Second Try<a hidden class=anchor aria-hidden=true href=#second-try>#</a></h2><p>The solution was to use vuex on the client and the server.
Thanks to Vue v3 composition API, it is way easier to run Vuex (sort of) on the server.
In my testing on my laptop, a single express instance could handle 50,000 Vuex stores (though that stress test isn&rsquo;t with all the clients connected, just by making toggling state).
So by creating a vuex store with specific format, it could easily be synced.</p><p><img loading=lazy srcset="https://matthewc.dev/projects/vuex-sync-p1/all_coming_together_hu4929d422eee5031178f35ab8b5afa36c_37511_360x0_resize_box_3.png 360w ,https://matthewc.dev/projects/vuex-sync-p1/all_coming_together_hu4929d422eee5031178f35ab8b5afa36c_37511_480x0_resize_box_3.png 480w ,https://matthewc.dev/projects/vuex-sync-p1/all_coming_together_hu4929d422eee5031178f35ab8b5afa36c_37511_720x0_resize_box_3.png 720w ,https://matthewc.dev/projects/vuex-sync-p1/all_coming_together_hu4929d422eee5031178f35ab8b5afa36c_37511_1080x0_resize_box_3.png 1080w ,https://matthewc.dev/projects/vuex-sync-p1/all_coming_together_hu4929d422eee5031178f35ab8b5afa36c_37511_1500x0_resize_box_3.png 1500w ,https://matthewc.dev/projects/vuex-sync-p1/all_coming_together.png 500w" sizes="(min-width: 768px) 720px, 100vw" src=https://matthewc.dev/projects/vuex-sync-p1/all_coming_together.png alt="all coming together"></p><p>There are a few rules for writing a store:</p><ul><li>All mutations must be deterministic, actions can be random.</li><li>Actions on the client side will be transmitted to the server</li><li>Actions must have the source of the action included in the payload, it is replaced by the server when the request comes in, so the actual client sends null</li><li>Mutations on the server as synced, any mutation with Server in the name is not synced</li><li>All synced stores must implement a method known as <code>setState</code> which accepts the state of the object and sets the state using vuex methods so reactivity is preserved</li><li>All synced stores must implement a getter that returns the hash of the current state (minus the server side information).</li></ul><p>All this boiled down to three basic pieces: client plugin, the server vuex, and the store itself.</p><h3 id=the-client-plugin>The Client Plugin<a hidden class=anchor aria-hidden=true href=#the-client-plugin>#</a></h3><p>There are a few steps to the client plugin:</p><ol><li>Create websocket</li><li>Connect the websocket&rsquo;s defined events to the plugin and some admin things</li><li>Setup reconnect events to request a sync</li></ol><p>The plugin itself also implements something akin to rollback netcode.</p><h4 id=step-1-2-creating-the-websocket>Step 1-2: Creating the websocket<a hidden class=anchor aria-hidden=true href=#step-1-2-creating-the-websocket>#</a></h4><p>In my main store which keeps track of login, the jwt cookie, the current game selected, and our user information, we have an action called <code>getLogin</code>.
I&rsquo;m using <code>vuex-smart-module</code> to define my vuex stores, since it&rsquo;s just so fantastic.
But you&rsquo;re welcome to adapt the ideas to whatever method you&rsquo;re using.
The <code>getLogin</code> method runs when the store is initialized.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>io</span>, <span style=color:#a6e22e>Socket</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;socket.io-client&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Store</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;vuex&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// Globals
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WebSocket</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Socket</span>&lt;<span style=color:#f92672>DefaultEventsMap</span><span style=color:#960050;background-color:#1e0010>,</span> <span style=color:#a6e22e>DefaultEventsMap</span>&gt;;
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>SOCKET</span>: <span style=color:#66d9ef>null</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>WebSocket</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// ... truncated ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainStoreActions</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Actions</span><span style=color:#f92672>&lt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MainStoreState</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MainStoreGetters</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MainStoreMutations</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MainStoreActions</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Called after the module is initialized
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>$init</span>(<span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Store</span>&lt;<span style=color:#f92672>any</span>&gt;)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>checkLogin</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>checkLogin() {</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>loggedIn</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... JWT parsing code truncated ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Connect
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>loggedIn</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>SOCKET</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SOCKET</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>io</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>auth</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>this.state.jwtCookie</span>,
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>self</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SOCKET</span>.<span style=color:#a6e22e>on</span>(<span style=color:#a6e22e>SocketEvents</span>.<span style=color:#a6e22e>SET_GAME</span>, (<span style=color:#a6e22e>item</span>: <span style=color:#66d9ef>unknown</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> (<span style=color:#a6e22e>item</span>) <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;string&#34;</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>game</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>item</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>game</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>currentGame</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;&#39;</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;refreshing the page to clear state&#34;</span>, <span style=color:#a6e22e>game</span>, <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>currentGame</span>);
</span></span><span style=display:flex><span>                window.<span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>reload</span>();
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>mutations</span>.<span style=color:#a6e22e>setGame</span>(<span style=color:#a6e22e>game</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SOCKET</span>.<span style=color:#a6e22e>on</span>(<span style=color:#a6e22e>SocketEvents</span>.<span style=color:#a6e22e>SERVER_MUTATION</span>, (<span style=color:#a6e22e>items</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>mutations</span>.<span style=color:#a6e22e>server_mutation</span>(<span style=color:#a6e22e>items</span>);
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SOCKET</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;reconnect&#39;</span>, ()<span style=color:#f92672>=&gt;</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>self</span>.<span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>requestGameSync</span>();
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>requestGameSync() {</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#a6e22e>SocketEvents</span>.<span style=color:#a6e22e>GAME_SYNC</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>emit</span>(<span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> [<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>any</span>]) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>SOCKET</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Socket isn&#39;t initialized, dropping message&#34;</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span>(<span style=color:#a6e22e>message</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;string&#39;</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>SOCKET</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> [<span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>items</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>SOCKET</span>.<span style=color:#a6e22e>emit</span>(<span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>items</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>There are three important things here, we listen for a <code>SET_GAME</code> event from the server, which reloads the page if we already had a game set. We also issue a special mutation called <code>setGame</code> which is leveraged later.
We listen to an event called <code>SERVER_MUTATION</code> and then confusingly we issue a new mutation called <code>server_mutation</code>, this will make sense.
Lastly, we tell it to request a resync packet when we reconnect. By default, the server doesn&rsquo;t listen to reconnects and just responds to reconnect packages as needed. This might be revised in the future.</p><p>Requesting a game sync packet is just emitting the <code>GAME_SYNC</code> packet.
Emitting is an action that leverages the socket.</p><p>Next we look at the mutations, setGame isn&rsquo;t anything special, we just set the local state.
<code>server_mutation</code> is strange as it doesn&rsquo;t do anything.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainStoreMutations</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Mutations</span>&lt;<span style=color:#f92672>MainStoreState</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setGame</span>(<span style=color:#a6e22e>game</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>currentGame</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>game</span>;<span style=color:#960050;background-color:#1e0010>ß</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>server_mutation</span>(<span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// the plugin will grab this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>We pass in some data to server_mutation, but don&rsquo;t use it.
The reason for this is that the plugin listens to that mutation.</p><p>If you&rsquo;re not familiar with the basics of vuex, I&rsquo;d recommend
<a href=https://vuex.vuejs.org/#what-is-a-state-management-pattern>brushing up</a>
.
The short version is that there are four parts to a vuex module (as of time of writing): state, getters, mutations, and actions.
State is the actual state of the store, which is reactive. It is readonly and can only be modified by mutations.
Getters are a way to map the state to different forms in a reactive way.
Mutations are methods that accept arguments and perform transformations to the state.
Actions are like mutations, but they cannot directly modify the state. Additionally, they can be async so you often put http calls in here.</p><h4 id=step-3-onto-the-plugin-itself>Step 3: Onto the plugin itself<a hidden class=anchor aria-hidden=true href=#step-3-onto-the-plugin-itself>#</a></h4><p>I&rsquo;ve broken it up into three sections.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ActionExtraPayload</span>, <span style=color:#a6e22e>ActionPacket</span>, <span style=color:#a6e22e>ActionPayload</span>, <span style=color:#a6e22e>ActionSource</span>, <span style=color:#a6e22e>isActionExtraPayload</span>, <span style=color:#a6e22e>isActionSource</span>, <span style=color:#a6e22e>MutationPacket</span>, <span style=color:#a6e22e>SocketEvents</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../../common/types&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Store</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;vuex&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>_</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;lodash&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Mutation packet looks like this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>interface  {
</span></span></span><span style=display:flex><span><span style=color:#75715e>  type: string;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  payload: any;
</span></span></span><span style=display:flex><span><span style=color:#75715e>  resultHash: number;
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>serverMutationChain</span>:<span style=color:#66d9ef>MutationPacket</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>localMutationChain</span>:<span style=color:#66d9ef>MutationPacket</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>resync_requested</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>clientSideSocketPlugin</span>(<span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Store</span>&lt;<span style=color:#f92672>any</span>&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>mutation</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>       <span style=color:#75715e>// ... mutations are tracked here ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    })
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>subscribeAction</span>({
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ... actions tracked here ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }, { <span style=color:#a6e22e>prepend</span>: <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>I&rsquo;ll put a huge disclaimer here that this is not polished code, this is code pumped out at 9pm in a after-work coding frenzy.
The kind of frenzy you get when you see progress being made and you keep pushing to extract whatever you can.</p><p>So you can see we subscribe to mutations and actions.
Additionally, we keep track of two &ldquo;chains&rdquo;: the local and the server.
The local chain is all the mutations that have occurred on the client and server is all the mutations that we&rsquo;ve received from the server.
These chains are reset when we set the game mode or receive a <code>setState</code> packet from the server as we now have a known state to start from.</p><p>Let&rsquo;s see how the we listen to mutations.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ActionExtraPayload</span>, <span style=color:#a6e22e>ActionPacket</span>, <span style=color:#a6e22e>ActionPayload</span>, <span style=color:#a6e22e>ActionSource</span>, <span style=color:#a6e22e>isActionExtraPayload</span>, <span style=color:#a6e22e>isActionSource</span>, <span style=color:#a6e22e>MutationPacket</span>, <span style=color:#a6e22e>SocketEvents</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../../common/types&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Store</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;vuex&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>_</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;lodash&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>serverMutationChain</span>:<span style=color:#66d9ef>MutationPacket</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>localMutationChain</span>:<span style=color:#66d9ef>MutationPacket</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>resync_requested</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>clientSideSocketPlugin</span>(<span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Store</span>&lt;<span style=color:#f92672>any</span>&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>mutation</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mutation</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;setGame&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Clear our chains when the game resets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Clearing mutation chains because game reset&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>gameName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mutation</span>.<span style=color:#a6e22e>payload</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>gameName</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;&#39;</span>) <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>commit</span>(<span style=color:#a6e22e>gameName</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#34;/setState&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>splice</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>splice</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentGame</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>getters</span>.<span style=color:#a6e22e>currentGame</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>currentGame</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>currentGame</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        <span style=color:#75715e>// We know we have a game
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mutation</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;server_mutation&#39;</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>packet</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>mutation</span>.<span style=color:#a6e22e>payload</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>MutationPacket</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>packet</span>.<span style=color:#66d9ef>type</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;setState&#34;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Special set state packet&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// reset both sets of mutation chains
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>resync_requested</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>splice</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>splice</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>packet</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Step 1: Check if we need to apply this packet, look in our local mutation chain to see if we&#39;ve already done it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>shouldApply</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>outOfSync</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Got server packet &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>packet</span>.<span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>serverMutationChain</span>, <span style=color:#a6e22e>localMutationChain</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>length</span>) <span style=color:#a6e22e>shouldApply</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>shouldApply</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// Scan ahead to see if we&#39;ve already done this exact commit?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>getters</span>[<span style=color:#a6e22e>currentGame</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/stateHash&#39;</span>];
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Scan ahead to see if we&#39;ve already applied this packet&#34;</span>,<span style=color:#a6e22e>hash</span>,<span style=color:#a6e22e>packet</span>.<span style=color:#a6e22e>resultHash</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>outOfSync</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hash</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>packet</span>.<span style=color:#a6e22e>resultHash</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>outOfSync</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>shouldApply</span>){
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;server mutation&#34;</span>, <span style=color:#a6e22e>mutation</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>packet</span>));
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>commit</span>(<span style=color:#a6e22e>packet</span>.<span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>packet</span>.<span style=color:#a6e22e>payload</span>);
</span></span><span style=display:flex><span>                <span style=color:#75715e>// TODO: look at state hash afterwards
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>getters</span>[<span style=color:#a6e22e>currentGame</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/stateHash&#39;</span>];
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;StateHash&#34;</span>, <span style=color:#a6e22e>hash</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hash</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>packet</span>.<span style=color:#a6e22e>resultHash</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>outOfSync</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;Local hash = &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>hash</span>, <span style=color:#a6e22e>packet</span>.<span style=color:#a6e22e>resultHash</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>outOfSync</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>serverMutationChain</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>type</span>.<span style=color:#a6e22e>endsWith</span>(<span style=color:#e6db74>&#34;setState&#34;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Replaying server commits&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>splice</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>forEach</span>((<span style=color:#a6e22e>x</span>)<span style=color:#f92672>=&gt;</span>{
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>commit</span>(<span style=color:#a6e22e>x</span>.<span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>payload</span>);
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>current_hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>getters</span>[<span style=color:#a6e22e>currentGame</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/stateHash&#39;</span>];
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>last_hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>serverMutationChain</span>[<span style=color:#a6e22e>serverMutationChain</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>resultHash</span>;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Replayed &#34;</span><span style=color:#f92672>+</span> <span style=color:#a6e22e>current_hash</span><span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; =?= &#34;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>last_hash</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>outOfSync</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>current_hash</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>last_hash</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>outOfSync</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>resync_requested</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>// We&#39;re out of sync, request a reset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#a6e22e>resync_requested</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#34;We&#39;ve becoming desynced&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>dispatch</span>(<span style=color:#e6db74>&#39;requestGameSync&#39;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>mutation</span>.<span style=color:#66d9ef>type</span>.<span style=color:#a6e22e>startsWith</span>(<span style=color:#a6e22e>currentGame</span>)){
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>getters</span>[<span style=color:#a6e22e>currentGame</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;/stateHash&#39;</span>];
</span></span><span style=display:flex><span>            <span style=color:#75715e>// we should log all other mutations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>packet</span>: <span style=color:#66d9ef>MutationPacket</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>resultHash</span>: <span style=color:#66d9ef>_.clone</span>(<span style=color:#a6e22e>hash</span>),
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>mutation</span>.<span style=color:#66d9ef>type</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>_.clone</span>(<span style=color:#a6e22e>mutation</span>.<span style=color:#a6e22e>payload</span>)
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>localMutationChain</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>packet</span>);
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;local mutation&#34;</span>, <span style=color:#a6e22e>packet</span>, <span style=color:#a6e22e>hash</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>subscribeAction</span>({
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ... actions tracked here ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }, { <span style=color:#a6e22e>prepend</span>: <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>So we listen to if we&rsquo;re doing a <code>setGame</code> mutation. If so, reset the chains and bail.
If we don&rsquo;t have a game currently set, we can also bail.
Then we check if this is a <code>server_mutation</code> mutation. Remember that from earlier? The wonky method that didn&rsquo;t do anything? Yeah- it&rsquo;s back baby.</p><p>Next we look at the mutation that the server wants us to apply.
If it&rsquo;s a <code>setState</code> packet, we can clear the chains and go ahead as normal.
We add the mutation to our server chain, then try to figure out if we need to apply the packet.
We do that by calculating the hash of the current state and looking at the hash that the server state is at.
<em>It&rsquo;s important that when we write our server hash function that we don&rsquo;t include server only data in our hash.</em>
We determine if we&rsquo;re out of sync from the server if our hashes don&rsquo;t match.
This is where rollback comes in, we start from the start of our chain (the first one should be a <code>setGame</code> packet), applying each packet we have from the server trying to make it all work and match.</p><p>If we have gotten to the end and we are still out of sync from the server, we request a resync packet.
This means the server sends a <code>setState</code> packet just to us so that we can clear our chains and get to work.
There needs to be some future work to add the client mutations ontop of what we have from the server, but currently the latency on the mutation occurring on the client and coming back from the server is under 200ms (not great, but enough that the likelihood of overlapping states are pretty low in most games).
This will likely get a much more comprehensive overhaul in the future.
Perhaps even with some unit tests?</p><p>Our games are
<a href=https://vuex.vuejs.org/guide/modules.html#namespacing>namespaced</a>
into the main vuex module so any mutation that&rsquo;s occurring locally on the client will be prepended with the name of the game.
For example, one game is called <code>matchup</code> so a common mutation we see is <code>setPlayerButton</code> so the event type would be <code>matchup/setPlayerButton</code>. If we see any mutations to start with our current game, we log them to our local chain.</p><p>Onto listening for actions.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ActionExtraPayload</span>, <span style=color:#a6e22e>ActionPacket</span>, <span style=color:#a6e22e>ActionPayload</span>, <span style=color:#a6e22e>ActionSource</span>, <span style=color:#a6e22e>isActionExtraPayload</span>, <span style=color:#a6e22e>isActionSource</span>, <span style=color:#a6e22e>MutationPacket</span>, <span style=color:#a6e22e>SocketEvents</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../../common/types&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Store</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;vuex&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>_</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;lodash&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>serverMutationChain</span>:<span style=color:#66d9ef>MutationPacket</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>localMutationChain</span>:<span style=color:#66d9ef>MutationPacket</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>resync_requested</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>clientSideSocketPlugin</span>(<span style=color:#a6e22e>store</span>: <span style=color:#66d9ef>Store</span>&lt;<span style=color:#f92672>any</span>&gt;) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>subscribe</span>(<span style=color:#a6e22e>mutation</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ... mutations are tracked here ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    })
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>subscribeAction</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>after</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>action</span>, <span style=color:#a6e22e>state</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>action</span>.<span style=color:#66d9ef>type</span>.<span style=color:#a6e22e>indexOf</span>(<span style=color:#e6db74>&#34;/&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>tweaked_payload</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>_</span>.<span style=color:#a6e22e>cloneDeep</span>(<span style=color:#a6e22e>action</span>.<span style=color:#a6e22e>payload</span>) <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ActionPayload</span><span style=color:#f92672>|</span><span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isActionSource</span>(<span style=color:#a6e22e>tweaked_payload</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>tweaked_payload</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isActionExtraPayload</span>(<span style=color:#a6e22e>tweaked_payload</span>)) {
</span></span><span style=display:flex><span>                (<span style=color:#a6e22e>tweaked_payload</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>any</span>).<span style=color:#a6e22e>source</span>  <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#75715e>// tell the server that we&#39;ve done a thing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>packet</span>:<span style=color:#66d9ef>ActionPacket</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>tweaked_payload</span>,
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>action</span>.<span style=color:#66d9ef>type</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>store</span>.<span style=color:#a6e22e>dispatch</span>(<span style=color:#e6db74>&#39;emit&#39;</span>, [<span style=color:#a6e22e>SocketEvents</span>.<span style=color:#a6e22e>CLIENT_ACTION</span>, <span style=color:#a6e22e>packet</span>]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }, { <span style=color:#a6e22e>prepend</span>: <span style=color:#66d9ef>true</span> });
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This is much simpler in comparison.
After an action has been completed, we check to make sure it was namespaced (look for <code>/</code>).
We have two types of payloads we can send to the server: <code>ActionSource</code> and <code>ActionExtraPayload</code>.
<code>ActionSource</code> looks like this</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ActionSource</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>_id</span>: <span style=color:#66d9ef>number</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>socket_id</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isAdmin</span>: <span style=color:#66d9ef>boolean</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>ActionExtraPayload</code> looks like this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ActionExtraPayload</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span>: <span style=color:#66d9ef>ActionSource</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>So the payload is either the source itself, or it has a member called source.
Before we send it off to the server, we set these to null and then send it.
This is important as on the server, we detect which type it is, and fill it in with the information from the socket JWT auth header.</p><h3 id=server-side>Server side<a hidden class=anchor aria-hidden=true href=#server-side>#</a></h3><p>Since this is already getting long, I&rsquo;ll cover the server side in part 2.
Since normal vuex doesn&rsquo;t run on the server, I implemented a slimmed down version of it that supports most of the same features.</p><h3 id=the-synced-store>The Synced Store<a hidden class=anchor aria-hidden=true href=#the-synced-store>#</a></h3><p>I&rsquo;ll cover the store itself in part 3.
There&rsquo;s a common store that implements things like users being added and removed.
All other stores extend from that store.</p><h2 id=where-to-go-from-here>Where To Go From Here?<a hidden class=anchor aria-hidden=true href=#where-to-go-from-here>#</a></h2><p>I&rsquo;m cleaning up my specific use private GitHub repo and publish a slimmed down version of this with a simple trivia game or maybe the stock market game I mentioned earlier.
I think I&rsquo;ll do that in part two, with some additional work working on improving the technique.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://matthewc.dev/tags/development/>development</a></li><li><a href=https://matthewc.dev/tags/vuex/>vuex</a></li><li><a href=https://matthewc.dev/tags/web/>web</a></li><li><a href=https://matthewc.dev/tags/typescript/>typescript</a></li></ul><nav class=paginav><a class=prev href=https://matthewc.dev/projects/passwordless-auth/><span class=title>« Prev Page</span><br><span>Simple Passwordless User Authorization</span></a>
<a class=next href=https://matthewc.dev/musings/great-british-effect/><span class=title>Next Page »</span><br><span>Great British Effect</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Vuex Sync Part 1 on twitter" href="https://twitter.com/intent/tweet/?text=Vuex%20Sync%20Part%201&url=https%3a%2f%2fmatthewc.dev%2fprojects%2fvuex-sync-p1%2f&hashtags=development%2cvuex%2cweb%2ctypescript"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Vuex Sync Part 1 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmatthewc.dev%2fprojects%2fvuex-sync-p1%2f&title=Vuex%20Sync%20Part%201&summary=Vuex%20Sync%20Part%201&source=https%3a%2f%2fmatthewc.dev%2fprojects%2fvuex-sync-p1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Vuex Sync Part 1 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmatthewc.dev%2fprojects%2fvuex-sync-p1%2f&title=Vuex%20Sync%20Part%201"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Vuex Sync Part 1 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmatthewc.dev%2fprojects%2fvuex-sync-p1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Vuex Sync Part 1 on whatsapp" href="https://api.whatsapp.com/send?text=Vuex%20Sync%20Part%201%20-%20https%3a%2f%2fmatthewc.dev%2fprojects%2fvuex-sync-p1%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Vuex Sync Part 1 on telegram" href="https://telegram.me/share/url?text=Vuex%20Sync%20Part%201&url=https%3a%2f%2fmatthewc.dev%2fprojects%2fvuex-sync-p1%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://matthewc.dev/>Matthew C Dev</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>papermod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>